#!/bin/bash

cat /etc/init.d/opennsl-modules | grep -q usemsi=1
if [ $? -ne 0 ];then
    sed -i '/modprobe[ \t]* linux-kernel-bde/  s/$/ usemsi=1/' /etc/init.d/opennsl-modules
fi

pr_info()
{
  echo "platform_init: $1"
}

#10G Merlin SFP+ Ports
#==================================

modprobe i2c-i801
modprobe i2c-dev

#Check devices
i2cset -y 0 0x77 0x0 0x1
i2cset -y 0 0x70 0x0 0x0
i2cset -y 0 0x71 0x0 0x20
i2cget -y 0 0x58 0 b > /dev/null 2>&1
if [ $? -ne 0 ];then
    pr_info "Device DS100(0x58) not found"
    i2cdetect -y 0
    exit 1
fi

#/*VOD DEM EQ Adjustment*/
i2cset -y 0 0x58 0x06 0x18
i2cset -y 0 0x58 0x0F 0x00
i2cset -y 0 0x58 0x16 0x00
i2cset -y 0 0x58 0x17 0xAA
i2cset -y 0 0x58 0x18 0x00
i2cset -y 0 0x58 0x1D 0x00
i2cset -y 0 0x58 0x24 0x00
i2cset -y 0 0x58 0x25 0xA8
i2cset -y 0 0x58 0x26 0x00
i2cset -y 0 0x58 0x2C 0x00
i2cset -y 0 0x58 0x2D 0xAA
i2cset -y 0 0x58 0x2E 0x00
i2cset -y 0 0x58 0x34 0xAA
i2cset -y 0 0x58 0x35 0x00
i2cset -y 0 0x58 0x3A 0x00
i2cset -y 0 0x58 0x3B 0xAA
i2cset -y 0 0x58 0x3C 0x00
i2cset -y 0 0x58 0x41 0x00
i2cset -y 0 0x58 0x42 0xAA
i2cset -y 0 0x58 0x43 0x00

#/* Select MAC to Front Port */
i2cset -y 0 0x58 0x5E 0x06
i2cset -y 0 0x58 0x5F 0x00

#Close device
i2cset -y 0 0x71 0x0 0x0
i2cset -y 0 0x77 0x0 0x0
#==================================

/usr/local/bin/idt_init.sh
/usr/local/bin/accton_as7326_util.py install
